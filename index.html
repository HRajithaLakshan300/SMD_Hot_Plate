<script>
const DEEPGRAM_KEY = "9b0ff54367ecc4f717993ea56ca1d3741d296f1e";

const client = mqtt.connect("acdb2ae09853439ea935f8823d722d8d.s1.eu.hivemq.cloud:8884/mqtt", {
  username: "Rajitha",
  password: "RajiL3He"
});

let mqttConnected = false;

client.on("connect", () => {
  console.log("âœ… MQTT Connected");
  mqttConnected = true;
});

client.on("error", err => {
  console.error("âŒ MQTT Error:", err);
});

// ---- VOICE ----
async function startListening() {
  console.log("ðŸŽ¤ Start listening");

  if (!mqttConnected) {
    alert("MQTT not connected");
    return;
  }

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const recorder = new MediaRecorder(stream);
  let chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = async () => {
    const blob = new Blob(chunks, { type: "audio/webm" });

    const res = await fetch("https://api.deepgram.com/v1/listen", {
      method: "POST",
      headers: {
        "Authorization": "Token " + DEEPGRAM_KEY,
        "Content-Type": "audio/webm"
      },
      body: blob
    });

    const data = await res.json();
    const text = data.results.channels[0].alternatives[0].transcript.toLowerCase();

    console.log("ðŸ—£ï¸ Heard:", text);

    if (text.includes("on")) {
      console.log("ðŸ“¤ Sending ON");
      client.publish("esp32/led", "ON");
    }
    if (text.includes("off")) {
      console.log("ðŸ“¤ Sending OFF");
      client.publish("esp32/led", "OFF");
    }
  };

  recorder.start();
  setTimeout(() => recorder.stop(), 3000);
}
</script>
